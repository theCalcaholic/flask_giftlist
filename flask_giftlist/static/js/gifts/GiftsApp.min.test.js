angular.module("GiftsApp",["ngRoute","ngMessages","ngCookies"]).config(["$routeProvider","$locationProvider",function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:"ajax/template/giftList.html",controller:"GiftListCtrl",controllerAs:"giftList"}).when("/claim/",{templateUrl:"ajax/template/claimGift.html",controller:"ClaimGiftCtrl",controllerAs:"vm"});$locationProvider.html5Mode(true)}]);(function(){DataProvider=function($q,$http,$location,Dialogs,Notify){var _callbacks=[];var _gifter={surname:null,name:null,email:null,email_confirm:null};var _newGift=null;var _selectedIndex=undefined;this.identity="DataProviderfactory";DataProvider={};DataProvider.gifts=[];Object.defineProperty(DataProvider,"selectedGift",{get:function(){if(_selectedIndex===undefined){return null}else if(_selectedIndex==="new"){return _newGift}else{return DataProvider.gifts[_selectedIndex]}},set:function(gift){if(gift===undefined){_selectedIndex=undefined}else if(gift.id){if(_newGift&&_newGift.id==gift.id){return _selectedIndex="new"}for(var i=0;i<DataProvider.gifts.length;i++){if(DataProvider.gifts[i].id=gift.id){_selectedIndex=i}}}},configurable:true});DataProvider.gifter=_gifter;Object.defineProperty(DataProvider,"selectedIndex",{get:function(){return _selectedIndex},set:function(index){if(index!==undefined&&(index==="new"||index<DataProvider.gifts.length)){_selectedIndex=index}}});DataProvider.saveGift=function(index){if(index&&index==="new"){gift=_newGift;url="ajax/gift/"+gift.id+"/"}else if(index<DataProvider.gifts.length){gift=DataProvider.gifts[index];url="ajax/gift/"+gift.id+"/save/"}else{Notify.flashMessage("Internal error: No such gift!");return}var data=new FormData;data.append("giftName",gift.giftName||"");data.append("prize",gift.prize||"");data.append("url",gift.url||"");data.append("description",gift.description||"");data.append("mailText",gift.mailText||"");data.append("image",gift.image||"");data.append("deleteImage",Boolean(gift.deleteImage));data.append("collaborative",Boolean(gift.collaborative));if(gift.imageFile){data.append("imageFile",gift.imageFile)}$http.post(url,data,{withCredentials:true,headers:{"Content-Type":undefined},transformRequest:angular.identity}).success(function(data,status,headers,config){if(data.errors.length){Notify.flashMessage({msg:"Speichern fehlgeschlagen.",type:"error",subMsgs:data.errors});_selectedIndex=index;Dialogs.showEditDialog()}else{Notify.flashMessage({msg:"Erfolgreich gespeichert"});console.log(this);DataProvider.updateGifts();if(index==="new"){_newGift=undefined}}}.bind(this)).error(function(data,status,headers,config){if(data){errors=data.errors}Notify.flashMessage({msg:"Speichern fehlgeschlagen.",type:"error",subMsgs:errors});_selectedIndex=index;Dialogs.showEditDialog()})};DataProvider.claimGift=function(index){if(_gifter&&index<DataProvider.gifts.length){console.log("gifter:");console.log(_gifter);var data=new FormData;data.append("surname",_gifter.surname);data.append("lastname",_gifter.lastname);data.append("email",_gifter.email);data.append("email_confirm",_gifter.email_confirm);data.append("prize",DataProvider.gifts[index].prize);console.log("data:");console.log(data);errorMsg="Beim reservieren des Geschenks ist ein Fehler aufgetreten. Bitte versuchen sie es noch einmal.";claimingMsgId=Notify.showMessage({msg:"Das Geschenk wird reserviert. Bitte warten...",type:"info"});$http.post("ajax/claim/"+DataProvider.gifts[index].id+"/",data).success(function(data,status,headers,config){Notify.hideMessage(claimingMsgId);if(data.errors.length){Notify.flashMessage({msg:errorMsg,subMsgs:data.errors,type:"error",duration:5e3})}else{Notify.flashMessage({msg:"Das Geschenk wurde reserviert.\n\rEine E-Mail mit allen wichtigen Informationen wurde an die angegebene E-Mail-Adresse versandt."});$location.path("/")}}).error(function(data,status,headers,config){errors=data.errors||[];Notify.hideMessage(claimingMsgId);Notify.flashMessage({msg:errorMsg,subMsgs:data.errors,type:"error",duration:5e3})})}};DataProvider.deleteGift=function(index){$http.post("ajax/gift/"+DataProvider.gifts[index].id+"/delete/").success(function(data,status,headers,config){Notify.flashMessage({msg:"Geschenk gelöscht."});selectedIndex=undefined;DataProvider.updateGifts()}).error(function(data,status,headers,config){Notify.flashMessage({msg:"Löschen fehlgeschlagen.",type:"error",duration:5e3,subMsgs:data.errors});_selectedIndex=index})};DataProvider.retrieveGifts=function(){if(DataProvider.gifts===undefined){return $q(function(resolve,reject){DataProvider.updateGifts().then(function(data){return data},function(data){return $q.reject(data)})})}else{return $q(function(resolve,reject){resolve(DataProvider.gifts)})}};DataProvider.updateGifts=function(){return $http.get("ajax/gifts/").success(function(data,status,headers,config){gifts=data.gifts;DataProvider.gifts=gifts;console.log("gifts updated: ");console.log(DataProvider.gifts);for(index in _callbacks){_callbacks[index]()}return DataProvider.gifts}).error(function(data,status,headers,config){Notify.flashMessage({msg:"Die Geschenkliste konnte nicht geladen werden.",type:"error",duration:7e3});return $q.reject(DataProvider.gifts)})};DataProvider.addGift=function(giftData){if(!_newGift){if(giftData!==undefined){_newGift=giftData}else{_newGift={id:"new",giftName:undefined,prize:undefined,url:"",description:undefined,mailText:undefined,image:undefined,imageFile:undefined,collaborative:false}}return _newGift}return null};DataProvider.giftById=function(id){if(id==="new"&&_newGift){return _newGift}else{for(gift in DataProvider.gifts){if(gift.id===id){return gift}}return null}};DataProvider.addListener=function(callback){_callbacks.push(callback)};return DataProvider};angular.module("GiftsApp").factory("DataProvider",["$q","$http","$location","Dialogs","Notify",DataProvider])})();(function(){Dialogs=function(){var _editDialogCtrl=null;var _claimDialogCtrl=null;var _deleteDialogCtrl=null;return{editDialog:function(dialog){if(dialog!==undefined){_editDialogCtrl=dialog}return _editDialogCtrl},claimDialog:function(dialog){_claimDialogCtrl=dialog},deleteDialog:function(dialog){if(dialog!==undefined){_deleteDialogCtrl=dialog}return _deleteDialogCtrl},showEditDialog:function(){_editDialogCtrl.show()},showClaimDialog:function(){_claimDialogCtrl.show()},showDeleteDialog:function(){_deleteDialogCtrl.show()}}};angular.module("GiftsApp").factory("Dialogs",Dialogs)})();Notify=function($timeout){var pendingMessages=[];var idCounter=0;this.notifications={length:0};this.identity="notify";this.flashMessage=function(args){itemId=this.showMessage(args);$timeout(this.hideMessage.bind(this),args.duration,true,itemId);return itemId};this.showMessage=function(args){args=validateArguments(args);itemId=String(idCounter);idCounter++;var newMsg={text:args.msg,type:args.type,subNotifications:args.subMsgs,id:itemId};Object.defineProperty(this.notifications,itemId,{enumerable:true,configurable:true,value:newMsg});this.notifications.length++;return itemId};this.hideMessage=function(id){delete this.notifications[String(id)];this.notifications.length--};validateArguments=function(args){if(!args){throw"missing parameters"}if(!args.msg){throw"missing required parameter: msg"}args.type=args.type||"info";args.duration=args.duration||3e3;args.subMsgs=args.subMsgs||[];return args}};angular.module("GiftsApp").service("Notify",["$timeout",Notify]);(function(){ClaimGiftCtrl=function(DataProvider){this.gift=DataProvider.selectedGift;this.gifter=DataProvider.gifter;this.claimView=true;this.submitClaim=function(){DataProvider.selectedGift=this.gift;DataProvider.claimGift(DataProvider.selectedIndex)}};angular.module("GiftsApp").controller("ClaimGiftCtrl",["DataProvider",ClaimGiftCtrl])})();(function(){GiftListCtrl=function($scope,DataProvider,Dialogs,Notify){this.gifts=DataProvider.gifts;this.loggedIn=false;this.notifications=Notify.notifications;var thiz=this;this.claimGift=function(index){DataProvider.selectedIndex=index;Dialogs.showClaimDialog()};this.editGift=function(index){if(index!==undefined){DataProvider.selectedIndex=index}else{DataProvider.selectedGift=DataProvider.addGift()}Dialogs.showEditDialog()};this.deleteGift=function(index){DataProvider.selectedIndex=index;Dialogs.showDeleteDialog()};this.closeDialog=function(){this.showForm=null};this.update=function(){DataProvider.updateGifts().then(function(gifts){console.log("update permanent?");console.log(DataProvider.gifts)}.bind(this))};this.resolve=function(){DataProvider.updateGifts()};this.notify=function(){Notify.flashMessage({msg:"Some random message."})};DataProvider.addListener(function(){this.gifts=DataProvider.gifts}.bind(this));this.update()};angular.module("GiftsApp").controller("GiftListCtrl",["$scope","DataProvider","Dialogs","Notify",GiftListCtrl])})();(function(){ClaimDialogCtrl=function($location,DataProvider,Dialogs){this.shown=false;this.gifter=DataProvider.gifter;this.show=function(){this.shown=true};this.close=function(){this.shown=false};this.submit=function(){if(this.form.$valid){$location.path("/claim/");this.close();DataProvider.gifter=this.gifter}this.form.$setDirty()};validString=function(bl){if(bl){return"valid"}else{return"invalid"}};this.debug=function(){this.gifter.surname="Tobias";this.gifter.lastname="Knöppler";this.gifter.email="tobias@knoeppler.net";this.gifter.email_confirm="tobias@knoeppler.net"};Dialogs.claimDialog(this)};ClaimDialogDirective=function(){return{restrict:"EA",templateUrl:"ajax/template/claimDialog.html",replace:true,transclude:false,controller:["$location","DataProvider","Dialogs",ClaimDialogCtrl],controllerAs:"dialog"}};angular.module("GiftsApp").directive("claimdialog",ClaimDialogDirective)})();(function(){EditDialogCtrl=function($location,$http,DataProvider,Dialogs){this.gift=DataProvider.selectedGift;this.shown=false;this.name="edit";this.show=function(){this.shown=true;this.gift=DataProvider.selectedGift;if(this.gift){this.form.$setDirty()}};this.close=function(){this.shown=false};this.submit=function(){if(this.form.$valid){this.close();DataProvider.saveGift(DataProvider.selectedIndex);this.form.$setPristine()}else{console.log(this.form);this.form.$setDirty()}alert("submit")};validString=function(bl){if(bl){return"valid"}else{return"invalid"}};Dialogs.editDialog(this)};EditDialogDirective=function(){return{restrict:"E",templateUrl:"ajax/template/editDialog.html",replace:true,scope:{},controller:["$location","$http","DataProvider","Dialogs",EditDialogCtrl],controllerAs:"dialog"}};angular.module("GiftsApp").directive("editDialog",EditDialogDirective)})();(function(){FieldErrors=function(){return{restrict:"E",scope:{field:"=field"},templateUrl:"ajax/template/fieldErrorMsgs.html",replace:true}};angular.module("GiftsApp").directive("fieldErrors",FieldErrors)})();(function(){NotificationsCtrl=function($scope,Notify){$scope.notifications=Notify.notifications;$scope.test="it works!";$scope.hideMessage=function(){Notify.hideMessage.bind(Notify)();$scope.notifications=Notify.notifications}};NotificationsDirective=function(){return{restrict:"E",templateUrl:"ajax/template/notifications.html",replace:true,transclude:false,controller:["$scope","Notify",NotificationsCtrl]}};angular.module("GiftsApp").directive("notifications",NotificationsDirective)})();(function(){DeleteDialogCtrl=function(DataProvider,Dialogs){this.shown=false;this.gift=DataProvider.selectedGift;this.name="delete";thiz=this;this.show=function(){this.gift=DataProvider.selectedGift;this.shown=true};this.close=function(){this.shown=false};this.submit=function(){if(this.form.$valid){this.close();this.form.$setPristine();DataProvider.selectedGift=this.gift;DataProvider.deleteGift(DataProvider.selectedIndex)}else{this.form.$setDirty()}};validString=function(bl){if(bl){return"valid"}else{return"invalid"}};thiz.debug=function(){};Dialogs.deleteDialog(this)};DeleteDialogDirective=function(){return{restrict:"E",templateUrl:"ajax/template/deleteDialog.html",replace:true,scope:{},controller:["DataProvider","Dialogs",DeleteDialogCtrl],controllerAs:"dialog"}};angular.module("GiftsApp").directive("deleteDialog",DeleteDialogDirective)})();(function(){EqualToDirective=function($parse){return{restrict:"A",require:"ngModel",scope:{compareValue:"=equalTo"},link:function($scope,elem,attrs,ctrl){$scope.$watch("compareValue",function(){ctrl.$validate()});ctrl.$validators.equalTo=function(modelValue,viewValue){if($scope.compareValue===modelValue){return true}else{return false}}}}};angular.module("GiftsApp").directive("equalTo",["$parse",EqualToDirective])})();(function(){GiftDirective=function(){return{restrict:"EA",templateUrl:"ajax/template/gift.html"}};angular.module("GiftsApp").directive("gift",GiftDirective)})();